<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéí Adventure Planner v2.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --light-bg: #f8f9fa;
            --border-color: #e9ecef;
            --text-muted: #6c757d;
            --shadow: 0 4px 15px rgba(0,0,0,0.1);
            --shadow-hover: 0 8px 25px rgba(0,0,0,0.15);
            --border-radius: 12px;
            --transition: all 0.3s ease;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 1rem;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: var(--primary-gradient);
            color: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            text-align: center;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .version-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255,255,255,0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            backdrop-filter: blur(10px);
        }

        .storage-monitor {
            background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
            border: 2px solid var(--success-color);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .storage-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .storage-bar {
            width: 200px;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .storage-fill {
            height: 100%;
            background: var(--primary-gradient);
            transition: var(--transition);
        }

        .save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            z-index: 1000;
            transition: var(--transition);
            transform: translateY(-100px);
        }

        .save-indicator.saving {
            background: var(--info-color);
            color: white;
            transform: translateY(0);
        }

        .save-indicator.saved {
            background: var(--success-color);
            color: white;
            transform: translateY(0);
        }

        .save-indicator.error {
            background: var(--danger-color);
            color: white;
            transform: translateY(0);
        }

        .card {
            background: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border: 1px solid var(--border-color);
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .section-title {
            font-size: 1.8rem;
            font-weight: 600;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .tabs {
            display: flex;
            background: var(--light-bg);
            border-radius: var(--border-radius);
            padding: 0.5rem;
            margin-bottom: 2rem;
            overflow-x: auto;
            gap: 0.25rem;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }

        .tab:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .tab.active {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin: 0.25rem;
            position: relative;
            overflow: hidden;
            font-family: inherit;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            transition: width 0.3s, height 0.3s;
            transform: translate(-50%, -50%);
        }

        .btn:hover::before {
            width: 100%;
            height: 100%;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: var(--text-muted);
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-warning {
            background: var(--warning-color);
            color: #212529;
        }

        .btn-info {
            background: var(--info-color);
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .row {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .col {
            flex: 1;
            min-width: 250px;
        }

        .col-auto {
            flex: 0 0 auto;
        }

        .day-card {
            background: var(--light-bg);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: var(--transition);
            position: relative;
        }

        .day-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .day-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
        }

        .day-cost {
            background: var(--primary-gradient);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
        }

        .progress-indicator {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 0.8rem;
        }

        .progress-high { background: var(--success-color); }
        .progress-medium { background: var(--warning-color); color: #333; }
        .progress-low { background: var(--danger-color); }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border: 1px solid var(--border-color);
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-hover);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-muted);
            font-weight: 500;
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .alert-success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }

        .alert-error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .alert-info {
            background: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }

        .progress-bar {
            background: #e9ecef;
            border-radius: 4px;
            height: 8px;
            overflow: hidden;
            margin: 0.5rem 0;
        }

        .progress-fill {
            background: var(--primary-gradient);
            height: 100%;
            transition: var(--transition);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            backdrop-filter: blur(5px);
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            position: relative;
            transform: scale(0.8);
            transition: var(--transition);
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        .close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .close-btn:hover {
            background: #c82333;
            transform: rotate(90deg);
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin: 2rem 0;
            flex-wrap: wrap;
        }

        .pagination button {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
        }

        .pagination button:hover {
            background: var(--light-bg);
        }

        .pagination button.active {
            background: var(--primary-gradient);
            color: white;
            border-color: transparent;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: var(--shadow-hover);
            z-index: 1001;
            transform: translateX(400px);
            transition: var(--transition);
            border-left: 4px solid;
            max-width: 300px;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success { border-left-color: var(--success-color); }
        .toast.error { border-left-color: var(--danger-color); }
        .toast.warning { border-left-color: var(--warning-color); }
        .toast.info { border-left-color: var(--info-color); }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            z-index: 1000;
        }

        .tooltip:hover::after {
            opacity: 1;
            visibility: visible;
        }

        .collapsible {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .collapsible-header {
            background: var(--light-bg);
            padding: 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
        }

        .collapsible-header:hover {
            background: #e9ecef;
        }

        .collapsible-content {
            padding: 1rem;
            display: none;
        }

        .collapsible.active .collapsible-content {
            display: block;
        }

        .collapsible.active .collapsible-toggle {
            transform: rotate(180deg);
        }

        .collapsible-toggle {
            transition: var(--transition);
            font-size: 1.2rem;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .row {
                flex-direction: column;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                text-align: center;
            }
            
            .modal-content {
                max-width: 95%;
                max-height: 95%;
                padding: 1rem;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }

            .storage-monitor {
                flex-direction: column;
                text-align: center;
            }

            .day-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease;
        }

        .slide-up {
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .quick-actions {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            z-index: 999;
        }

        .quick-action-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            background: var(--primary-gradient);
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quick-action-btn:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-hover);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="version-badge">v2.0</div>
            <h1>üéí Adventure Planner</h1>
            <p>Plan your perfect journey with enhanced features and smart storage management</p>
        </div>

        <!-- Save Indicator -->
        <div id="saveIndicator" class="save-indicator"></div>

        <!-- Storage Monitor -->
        <div id="storageMonitor" class="storage-monitor">
            <div class="storage-info">
                <span>üíæ <strong>Storage:</strong> <span id="storageUsed">0 MB</span> / 4 MB</span>
                <div class="storage-bar">
                    <div id="storageFill" class="storage-fill" style="width: 0%"></div>
                </div>
            </div>
            <div>
                <button class="btn btn-info btn-sm" onclick="showStorageDetails()">üìä Details</button>
                <button class="btn btn-warning btn-sm" onclick="optimizeStorage()">üîß Optimize</button>
            </div>
        </div>

        <!-- Stats Overview -->
        <div id="statsOverview" class="stats-grid" style="display: none;">
            <div class="stat-card">
                <div class="stat-value" id="totalDays">0</div>
                <div class="stat-label">üìÖ Total Days</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalCost">¬£0</div>
                <div class="stat-label">üí∞ Total Cost</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="documentsCount">0</div>
                <div class="stat-label">üìÑ Documents</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="tasksCount">0</div>
                <div class="stat-label">‚úÖ Tasks</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="completionRate">0%</div>
                <div class="stat-label">üéØ Completion</div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('overview')">üåç Overview</button>
            <button class="tab" onclick="showTab('planning')">üìÖ Planning</button>
            <button class="tab" onclick="showTab('documents')">üìÑ Documents</button>
            <button class="tab" onclick="showTab('todos')">‚úÖ Tasks</button>
            <button class="tab" onclick="showTab('budget')">üí∞ Budget</button>
            <button class="tab" onclick="showTab('analytics')">üìä Analytics</button>
            <button class="tab" onclick="showTab('backup')">üíæ Backup</button>
        </div>

        <!-- Trip Overview Tab -->
        <div id="overview" class="tab-content active">
            <div class="card fade-in">
                <h2 class="section-title">üåç Trip Overview</h2>
                
                <div class="row">
                    <div class="col">
                        <div class="form-group">
                            <label for="tripName">üéØ Trip Name</label>
                            <input type="text" id="tripName" placeholder="e.g., European Adventure" maxlength="100">
                        </div>
                        
                        <div class="form-group">
                            <label for="startDate">üìÖ Start Date</label>
                            <input type="date" id="startDate">
                        </div>
                        
                        <div class="form-group">
                            <label for="endDate">üèÅ End Date</label>
                            <input type="date" id="endDate">
                        </div>
                    </div>
                    
                    <div class="col">
                        <div class="form-group">
                            <label for="destinations">üó∫Ô∏è Main Destinations</label>
                            <textarea id="destinations" rows="4" placeholder="List your must-visit places..." maxlength="500"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="totalBudget">üí∞ Total Budget (¬£)</label>
                            <input type="number" id="totalBudget" min="0" max="100000" step="100" value="1000">
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col">
                        <div class="form-group">
                            <label for="travelStyle">‚úàÔ∏è Travel Style</label>
                            <select id="travelStyle">
                                <option value="üéí Budget Backpacker (¬£25-40/day)">üéí Budget Backpacker (¬£25-40/day)</option>
                                <option value="üåü Mid-range Explorer (¬£40-70/day)">üåü Mid-range Explorer (¬£40-70/day)</option>
                                <option value="üíé Comfort Traveller (¬£70+/day)">üíé Comfort Traveller (¬£70+/day)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="col">
                        <div class="form-group">
                            <label for="groupSize">üë• Group Size</label>
                            <input type="number" id="groupSize" min="1" max="20" value="1">
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="saveTripOverview()">üíæ Save Trip Overview</button>
                <button class="btn btn-info" onclick="generateSuggestedItinerary()">üéØ Generate Suggestions</button>
            </div>
        </div>

        <!-- Day Planning Tab -->
        <div id="planning" class="tab-content">
            <div class="card">
                <h2 class="section-title">üìÖ Day-by-Day Planning</h2>
                
                <div class="row" style="margin-bottom: 2rem; align-items: center;">
                    <div class="col">
                        <button class="btn btn-primary" onclick="addNewDay()">‚ûï Add Day</button>
                        <button class="btn btn-secondary" onclick="addMultipleDays()">üìÖ Add Multiple</button>
                        <input type="number" id="daysToAdd" min="1" max="10" value="1" style="width: 80px; margin-left: 0.5rem;">
                        <button class="btn btn-info" onclick="duplicateDay()">üìã Duplicate</button>
                    </div>
                    <div class="col-auto">
                        <span class="tooltip" data-tooltip="Current: 0/100 days">
                            Days: <strong id="dayCount">0</strong>/100
                        </span>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-danger" onclick="clearAllDays()">üóëÔ∏è Clear All</button>
                    </div>
                </div>

                <!-- Day Filters -->
                <div class="row" style="margin-bottom: 1rem;">
                    <div class="col">
                        <button class="btn btn-secondary btn-sm" onclick="filterDays('all')">All Days</button>
                        <button class="btn btn-warning btn-sm" onclick="filterDays('incomplete')">Incomplete</button>
                        <button class="btn btn-success btn-sm" onclick="filterDays('complete')">Complete</button>
                        <button class="btn btn-info btn-sm" onclick="sortDays('date')">Sort by Date</button>
                    </div>
                </div>
                
                <div id="daysList">
                    <!-- Days will be dynamically added here -->
                </div>

                <!-- Pagination -->
                <div id="daysPagination" class="pagination"></div>
            </div>
        </div>

        <!-- Documents Tab -->
        <div id="documents" class="tab-content">
            <div class="card">
                <h2 class="section-title">üìÑ Documents & Reservations</h2>
                
                <div class="row" style="margin-bottom: 2rem;">
                    <div class="col">
                        <div class="collapsible">
                            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                                <span>‚ûï Add New Document</span>
                                <span class="collapsible-toggle">‚ñº</span>
                            </div>
                            <div class="collapsible-content">
                                <div class="row">
                                    <div class="col">
                                        <div class="form-group">
                                            <label for="documentDay">üìÖ Day</label>
                                            <select id="documentDay">
                                                <option value="">Select Day</option>
                                                <!-- Options will be populated dynamically -->
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="documentType">üìÇ Document Type</label>
                                            <select id="documentType">
                                                <option value="üé´ Transport Ticket">üé´ Transport Ticket</option>
                                                <option value="üè® Hotel Reservation">üè® Hotel Reservation</option>
                                                <option value="üéüÔ∏è Activity Booking">üéüÔ∏è Activity Booking</option>
                                                <option value="üçΩÔ∏è Restaurant Reservation">üçΩÔ∏è Restaurant Reservation</option>
                                                <option value="üìã Visa/Permit">üìã Visa/Permit</option>
                                                <option value="üé™ Event Ticket">üé™ Event Ticket</option>
                                                <option value="üöó Car Rental">üöó Car Rental</option>
                                                <option value="üìÑ Other">üìÑ Other</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="documentName">üìù Document Name</label>
                                            <input type="text" id="documentName" placeholder="e.g., Eurostar to Paris" maxlength="100">
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div class="form-group">
                                            <label for="documentDetails">üìã Details</label>
                                            <textarea id="documentDetails" rows="3" placeholder="Confirmation number, time, notes..." maxlength="300"></textarea>
                                        </div>
                                        <div class="form-group">
                                            <label for="documentStatus">‚úÖ Status</label>
                                            <select id="documentStatus">
                                                <option value="pending">üü° Pending</option>
                                                <option value="confirmed">üü¢ Confirmed</option>
                                                <option value="cancelled">üî¥ Cancelled</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="documentFile">üìé Attach File (Max 2MB)</label>
                                    <input type="file" id="documentFile" accept=".pdf,.jpg,.jpeg,.png,.gif,.doc,.docx,.txt">
                                    <small style="color: var(--text-muted);">Supported: PDF, Images, Word docs, Text files</small>
                                </div>
                                <div class="row">
                                    <div class="col">
                                        <button class="btn btn-primary" onclick="addDocument()">‚ûï Add Document</button>
                                    </div>
                                    <div class="col-auto">
                                        <span class="tooltip" data-tooltip="Current documents count">
                                            Docs: <strong id="docCount">0</strong>/200
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="documentsContainer">
                    <!-- Documents will be displayed here -->
                </div>
            </div>
        </div>

        <!-- Tasks Tab -->
        <div id="todos" class="tab-content">
            <div class="card">
                <h2 class="section-title">‚úÖ Task Management</h2>
                
                <div class="row" style="margin-bottom: 2rem;">
                    <div class="col">
                        <div class="collapsible">
                            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                                <span>‚ûï Add New Task</span>
                                <span class="collapsible-toggle">‚ñº</span>
                            </div>
                            <div class="collapsible-content">
                                <div class="row">
                                    <div class="col">
                                        <div class="form-group">
                                            <label for="todoTitle">üìã Task Title</label>
                                            <input type="text" id="todoTitle" placeholder="e.g., Book train tickets" maxlength="100">
                                        </div>
                                        <div class="form-group">
                                            <label for="todoDescription">üìù Description</label>
                                            <textarea id="todoDescription" rows="2" placeholder="Additional details..." maxlength="200"></textarea>
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div class="form-group">
                                            <label for="todoPriority">‚ö° Priority</label>
                                            <select id="todoPriority">
                                                <option value="high">üî¥ High</option>
                                                <option value="medium" selected>üü° Medium</option>
                                                <option value="low">üü¢ Low</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="todoDueDate">üìÖ Due Date</label>
                                            <input type="date" id="todoDueDate">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col">
                                        <div class="form-group">
                                            <label for="todoCategory">üè∑Ô∏è Category</label>
                                            <select id="todoCategory">
                                                <option value="üìã General">üìã General</option>
                                                <option value="üé´ Bookings">üé´ Bookings</option>
                                                <option value="üìÑ Documents">üìÑ Documents</option>
                                                <option value="üß≥ Packing">üß≥ Packing</option>
                                                <option value="üí∞ Financial">üí∞ Financial</option>
                                                <option value="üè• Health">üè• Health</option>
                                                <option value="üì± Technology">üì± Technology</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col">
                                        <button class="btn btn-primary" onclick="addTodo()" style="margin-top: 1.8rem;">‚ûï Add Task</button>
                                        <span class="tooltip" data-tooltip="Current tasks count" style="margin-left: 1rem;">
                                            Tasks: <strong id="taskCount">0</strong>/100
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Task Filters -->
                <div class="row" style="margin-bottom: 1rem;">
                    <div class="col">
                        <button class="btn btn-secondary btn-sm" onclick="filterTodos('all')">üìã All</button>
                        <button class="btn btn-warning btn-sm" onclick="filterTodos('pending')">‚è≥ Pending</button>
                        <button class="btn btn-success btn-sm" onclick="filterTodos('completed')">‚úÖ Completed</button>
                        <button class="btn btn-danger btn-sm" onclick="filterTodos('high')">üî¥ High Priority</button>
                        <button class="btn btn-info btn-sm" onclick="filterTodos('overdue')">‚ö†Ô∏è Overdue</button>
                    </div>
                </div>
                
                <div id="todoStats" class="stats-grid" style="margin-bottom: 2rem;">
                    <!-- Todo stats will be populated here -->
                </div>
                
                <div id="todosContainer">
                    <!-- Todos will be displayed here -->
                </div>
            </div>
        </div>

        <!-- Budget Tab -->
        <div id="budget" class="tab-content">
            <div class="card">
                <h2 class="section-title">üí∞ Smart Budget Management</h2>
                
                <div class="row">
                    <div class="col">
                        <h3>üçΩÔ∏è Daily Expenses</h3>
                        <div class="form-group">
                            <label for="foodBudget">Food & Drink (¬£/day)</label>
                            <input type="number" id="foodBudget" min="0" max="200" step="5" value="0">
                        </div>
                        <div class="form-group">
                            <label for="activitiesBudget">Activities (¬£/day)</label>
                            <input type="number" id="activitiesBudget" min="0" max="200" step="5" value="0">
                        </div>
                        <div class="form-group">
                            <label for="localTransportBudget">Local Transport (¬£/day)</label>
                            <input type="number" id="localTransportBudget" min="0" max="100" step="2" value="0">
                        </div>
                    </div>
                    
                    <div class="col">
                        <h3>üõçÔ∏è One-time Expenses</h3>
                        <div class="form-group">
                            <label for="shoppingBudget">Shopping (¬£ total)</label>
                            <input type="number" id="shoppingBudget" min="0" max="5000" step="10" value="0">
                        </div>
                        <div class="form-group">
                            <label for="gearBudget">Equipment/Gear (¬£)</label>
                            <input type="number" id="gearBudget" min="0" max="2000" step="10" value="0">
                        </div>
                        <div class="form-group">
                            <label for="miscBudget">Miscellaneous (¬£)</label>
                            <input type="number" id="miscBudget" min="0" max="1000" step="10" value="0">
                        </div>
                    </div>
                    
                    <div class="col">
                        <h3>üõ°Ô∏è Safety & Insurance</h3>
                        <div class="form-group">
                            <label for="emergencyBudget">Emergency Fund (¬£)</label>
                            <input type="number" id="emergencyBudget" min="0" max="5000" step="25" value="0">
                        </div>
                        <div class="form-group">
                            <label for="insuranceBudget">Insurance (¬£)</label>
                            <input type="number" id="insuranceBudget" min="0" max="500" step="5" value="0">
                        </div>
                        <div class="form-group">
                            <label for="visaBudget">Visas/Permits (¬£)</label>
                            <input type="number" id="visaBudget" min="0" max="500" step="5" value="0">
                        </div>
                    </div>
                </div>
                
                <div id="budgetOverview" class="stats-grid">
                    <!-- Budget stats will be populated here -->
                </div>
                
                <div id="budgetAnalysis">
                    <!-- Budget analysis and recommendations -->
                </div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics" class="tab-content">
            <div class="card">
                <h2 class="section-title">üìä Trip Analytics & Insights</h2>
                <div id="analyticsContent">
                    <p style="text-align: center; color: var(--text-muted);">Add trip data to see detailed analytics!</p>
                </div>
            </div>
        </div>

        <!-- Backup Tab -->
        <div id="backup" class="tab-content">
            <div class="card">
                <h2 class="section-title">üíæ Backup & Data Management</h2>
                
                <div class="row">
                    <div class="col">
                        <h3>üì• Export Data</h3>
                        <div style="margin-bottom: 1rem;">
                            <button class="btn btn-primary" onclick="exportFullBackup()">üíæ Full Backup (JSON)</button>
                            <button class="btn btn-secondary" onclick="exportToCSV()">üìä Trip Data (CSV)</button>
                            <button class="btn btn-info" onclick="generateTextSummary()">üìã Text Summary</button>
                        </div>
                        
                        <h3>üì§ Import Data</h3>
                        <div class="form-group">
                            <label for="importFile">Import Backup File</label>
                            <input type="file" id="importFile" accept=".json" onchange="importBackup(this.files[0])">
                        </div>
                    </div>
                    
                    <div class="col">
                        <h3>üîß Data Management</h3>
                        <div style="margin-bottom: 1rem;">
                            <button class="btn btn-warning" onclick="compressData()">üóúÔ∏è Compress Data</button>
                            <button class="btn btn-info" onclick="validateData()">‚úÖ Validate Data</button>
                            <button class="btn btn-secondary" onclick="showDataStats()">üìà Data Statistics</button>
                        </div>
                        
                        <h3>‚ö†Ô∏è Danger Zone</h3>
                        <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
                        <small style="color: var(--text-muted); display: block; margin-top: 0.5rem;">
                            This action cannot be undone. Export backup first!
                        </small>
                    </div>
                </div>
                
                <div id="backupStatus" style="margin-top: 2rem;">
                    <!-- Backup status and history -->
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <button class="quick-action-btn tooltip" data-tooltip="Add New Day" onclick="addNewDay()">üìÖ</button>
        <button class="quick-action-btn tooltip" data-tooltip="Add Document" onclick="showTab('documents'); toggleCollapsible(document.querySelector('#documents .collapsible-header'))">üìÑ</button>
        <button class="quick-action-btn tooltip" data-tooltip="Add Task" onclick="showTab('todos'); toggleCollapsible(document.querySelector('#todos .collapsible-header'))">‚úÖ</button>
        <button class="quick-action-btn tooltip" data-tooltip="Backup Data" onclick="exportFullBackup()">üíæ</button>
    </div>

    <script>
        // Enhanced Global Variables with Limits
        const LIMITS = {
            MAX_DAYS: 100,
            MAX_DOCUMENTS: 200,
            MAX_TODOS: 100,
            MAX_FILE_SIZE: 2 * 1024 * 1024, // 2MB
            MAX_TOTAL_STORAGE: 4 * 1024 * 1024, // 4MB
            ITEMS_PER_PAGE: 10
        };

        let tripData = [];
        let documentsData = [];
        let todosData = [];
        let budgetData = {
            totalBudget: 1000,
            foodBudget: 0,
            activitiesBudget: 0,
            localTransportBudget: 0,
            shoppingBudget: 0,
            gearBudget: 0,
            miscBudget: 0,
            emergencyBudget: 0,
            insuranceBudget: 0,
            visaBudget: 0
        };
        let tripInfo = {};
        let currentPage = 1;
        let currentFilter = 'all';
        let currentTodoFilter = 'all';

        // Enhanced Initialization
        window.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            loadFromStorage();
            setupEventListeners();
            updateAllUI();
            checkStorageUsage();
            showToast('‚úÖ Adventure Planner v2.0 loaded successfully!', 'success');
        }

        // Enhanced Storage Management
        function saveToStorage() {
            try {
                showSaveIndicator('saving');
                
                const data = {
                    version: '2.0',
                    tripData,
                    documentsData,
                    todosData,
                    budgetData,
                    tripInfo,
                    lastSaved: new Date().toISOString(),
                    metadata: {
                        dayCount: tripData.length,
                        documentCount: documentsData.length,
                        todoCount: todosData.length
                    }
                };

                const dataString = JSON.stringify(data);
                const dataSize = new Blob([dataString]).size;

                if (dataSize > LIMITS.MAX_TOTAL_STORAGE) {
                    throw new Error('Storage limit exceeded');
                }

                // In-memory storage for this demo
                window.adventurePlannerData = data;
                
                showSaveIndicator('saved');
                updateStorageMonitor();
                
            } catch (error) {
                console.error('Save error:', error);
                showSaveIndicator('error');
                
                if (error.message === 'Storage limit exceeded') {
                    showToast('‚ö†Ô∏è Storage limit exceeded! Consider removing large files or old data.', 'warning');
                    suggestOptimization();
                } else {
                    showToast('‚ùå Failed to save data: ' + error.message, 'error');
                }
            }
        }

        function loadFromStorage() {
            try {
                // Load from memory or localStorage fallback
                const saved = window.adventurePlannerData || 
                             (localStorage.getItem('adventurePlannerData') ? 
                              JSON.parse(localStorage.getItem('adventurePlannerData')) : null);
                
                if (saved) {
                    tripData = saved.tripData || [];
                    documentsData = saved.documentsData || [];
                    todosData = saved.todosData || [];
                    budgetData = { ...budgetData, ...(saved.budgetData || {}) };
                    tripInfo = saved.tripInfo || {};
                    
                    populateFormFields();
                    showToast('‚úÖ Data loaded successfully!', 'success');
                }
            } catch (error) {
                console.error('Load error:', error);
                showToast('‚ö†Ô∏è Error loading data. Starting fresh.', 'warning');
            }
        }

        function populateFormFields() {
            // Trip info
            if (tripInfo.name) document.getElementById('tripName').value = tripInfo.name;
            if (tripInfo.startDate) document.getElementById('startDate').value = tripInfo.startDate;
            if (tripInfo.endDate) document.getElementById('endDate').value = tripInfo.endDate;
            if (tripInfo.destinations) document.getElementById('destinations').value = tripInfo.destinations;
            if (tripInfo.totalBudget) document.getElementById('totalBudget').value = tripInfo.totalBudget;
            if (tripInfo.travelStyle) document.getElementById('travelStyle').value = tripInfo.travelStyle;
            if (tripInfo.groupSize) document.getElementById('groupSize').value = tripInfo.groupSize;

            // Budget fields
            Object.keys(budgetData).forEach(key => {
                const element = document.getElementById(key);
                if (element) element.value = budgetData[key] || 0;
            });
        }

        // Enhanced UI Functions
        function showSaveIndicator(status) {
            const indicator = document.getElementById('saveIndicator');
            indicator.className = `save-indicator ${status}`;
            
            switch(status) {
                case 'saving':
                    indicator.innerHTML = '<div class="loading"></div>Saving...';
                    break;
                case 'saved':
                    indicator.innerHTML = '‚úÖ Saved';
                    setTimeout(() => {
                        indicator.className = 'save-indicator';
                    }, 2000);
                    break;
                case 'error':
                    indicator.innerHTML = '‚ùå Save Failed';
                    setTimeout(() => {
                        indicator.className = 'save-indicator';
                    }, 3000);
                    break;
            }
        }

        function showToast(message, type = 'info', duration = 4000) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 1.2rem; cursor: pointer; margin-left: 1rem;">&times;</button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        function updateStorageMonitor() {
            try {
                const data = JSON.stringify({
                    tripData, documentsData, todosData, budgetData, tripInfo
                });
                const sizeInMB = (new Blob([data]).size / (1024 * 1024));
                const percentage = (sizeInMB / 4) * 100;
                
                document.getElementById('storageUsed').textContent = sizeInMB.toFixed(2) + ' MB';
                document.getElementById('storageFill').style.width = percentage + '%';
                
                const monitor = document.getElementById('storageMonitor');
                if (percentage > 90) {
                    monitor.style.borderColor = 'var(--danger-color)';
                    monitor.style.background = 'linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%)';
                } else if (percentage > 75) {
                    monitor.style.borderColor = 'var(--warning-color)';
                    monitor.style.background = 'linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%)';
                } else {
                    monitor.style.borderColor = 'var(--success-color)';
                    monitor.style.background = 'linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%)';
                }
                
            } catch (error) {
                console.error('Storage monitoring error:', error);
            }
        }

        function checkStorageUsage() {
            updateStorageMonitor();
            const data = JSON.stringify({ tripData, documentsData, todosData, budgetData, tripInfo });
            const sizeInMB = (new Blob([data]).size / (1024 * 1024));
            
            if (sizeInMB > 3.5) {
                showToast('‚ö†Ô∏è Storage almost full! Consider optimizing your data.', 'warning');
            }
        }

        // Enhanced Tab System
        function showTab(tabName) {
            // Remove active from all tabs and contents
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Activate selected tab
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            // Update content based on tab
            switch(tabName) {
                case 'planning':
                    updateDaysList();
                    break;
                case 'documents':
                    updateDocumentDayOptions();
                    updateDocumentsView();
                    break;
                case 'todos':
                    updateTodosView();
                    break;
                case 'budget':
                    updateBudgetOverview();
                    break;
                case 'analytics':
                    updateAnalytics();
                    break;
                case 'backup':
                    updateBackupStatus();
                    break;
            }
        }

        // Enhanced Event Listeners
        function setupEventListeners() {
            // Auto-save on budget changes with debouncing
            const budgetFields = ['foodBudget', 'activitiesBudget', 'localTransportBudget', 
                                'shoppingBudget', 'gearBudget', 'miscBudget', 'emergencyBudget', 
                                'insuranceBudget', 'visaBudget'];
            
            budgetFields.forEach(field => {
                const element = document.getElementById(field);
                if (element) {
                    element.addEventListener('input', debounce(() => {
                        budgetData[field] = parseFloat(element.value) || 0;
                        saveToStorage();
                        updateBudgetOverview();
                    }, 500));
                }
            });

            // Date validation
            document.getElementById('startDate').addEventListener('change', validateDates);
            document.getElementById('endDate').addEventListener('change', validateDates);

            // Storage monitoring
            setInterval(checkStorageUsage, 30000); // Check every 30 seconds
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function validateDates() {
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            
            if (startDate && endDate && endDate < startDate) {
                showToast('‚ö†Ô∏è End date must be after start date!', 'warning');
                document.getElementById('endDate').value = '';
            }
        }

        // Enhanced Trip Overview Functions
        function saveTripOverview() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (startDate && endDate && new Date(endDate) < new Date(startDate)) {
                showToast('‚ùå End date must be after start date!', 'error');
                return;
            }

            tripInfo = {
                name: document.getElementById('tripName').value.trim(),
                startDate,
                endDate,
                destinations: document.getElementById('destinations').value.trim(),
                totalBudget: parseFloat(document.getElementById('totalBudget').value) || 1000,
                travelStyle: document.getElementById('travelStyle').value,
                groupSize: parseInt(document.getElementById('groupSize').value) || 1
            };
            
            budgetData.totalBudget = tripInfo.totalBudget;
            
            saveToStorage();
            updateAllUI();
            showToast('‚úÖ Trip overview saved!', 'success');
            
            // Budget suggestion
            if (startDate && endDate) {
                const days = Math.ceil((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24)) + 1;
                const suggestedBudget = calculateSuggestedBudget(tripInfo.travelStyle, days);
                
                if (tripInfo.totalBudget < suggestedBudget * 0.8) {
                    showToast(`üí° Consider budgeting ¬£${suggestedBudget.toFixed(0)} for ${days} days based on your travel style`, 'info');
                }
            }
        }

        function calculateSuggestedBudget(travelStyle, days) {
            const dailyRates = {
                'üéí Budget Backpacker (¬£25-40/day)': 32.5,
                'üåü Mid-range Explorer (¬£40-70/day)': 55,
                'üíé Comfort Traveller (¬£70+/day)': 95
            };
            return (dailyRates[travelStyle] || 50) * days;
        }

        function generateSuggestedItinerary() {
            if (!tripInfo.destinations) {
                showToast('‚ùå Please add destinations first!', 'error');
                return;
            }

            const destinations = tripInfo.destinations.split(',').map(d => d.trim()).filter(d => d);
            if (destinations.length === 0) {
                showToast('‚ùå Please add valid destinations!', 'error');
                return;
            }

            const startDate = new Date(tripInfo.startDate || new Date());
            
            destinations.forEach((destination, index) => {
                const dayDate = new Date(startDate);
                dayDate.setDate(dayDate.getDate() + index);
                
                const newDay = {
                    day: tripData.length + 1,
                    date: dayDate.toISOString().split('T')[0],
                    location: destination,
                    transportType: 'Bus',
                    transportFrom: index > 0 ? destinations[index - 1] : '',
                    transportTo: destination,
                    transportTime: '',
                    transportCost: 0,
                    accommodationType: 'Hostel',
                    accommodationName: '',
                    accommodationCost: 0,
                    notes: `Explore ${destination} - suggested activities and sightseeing`
                };
                
                tripData.push(newDay);
            });

            saveToStorage();
            updateAllUI();
            showTab('planning');
            showToast(`‚úÖ Generated ${destinations.length} days based on your destinations!`, 'success');
        }

        // Enhanced Day Planning Functions
        function validateLimits(type, count = 1) {
            switch(type) {
                case 'days':
                    if (tripData.length + count > LIMITS.MAX_DAYS) {
                        showToast(`‚ùå Maximum ${LIMITS.MAX_DAYS} days allowed! Currently have ${tripData.length}.`, 'error');
                        return false;
                    }
                    break;
                case 'documents':
                    if (documentsData.length + count > LIMITS.MAX_DOCUMENTS) {
                        showToast(`‚ùå Maximum ${LIMITS.MAX_DOCUMENTS} documents allowed! Currently have ${documentsData.length}.`, 'error');
                        return false;
                    }
                    break;
                case 'todos':
                    if (todosData.length + count > LIMITS.MAX_TODOS) {
                        showToast(`‚ùå Maximum ${LIMITS.MAX_TODOS} tasks allowed! Currently have ${todosData.length}.`, 'error');
                        return false;
                    }
                    break;
            }
            return true;
        }

        function addNewDay() {
            if (!validateLimits('days')) return;

            const lastDay = tripData[tripData.length - 1];
            let newDate = '';
            
            if (lastDay && lastDay.date) {
                const lastDate = new Date(lastDay.date);
                lastDate.setDate(lastDate.getDate() + 1);
                newDate = lastDate.toISOString().split('T')[0];
            } else if (tripInfo.startDate) {
                const startDate = new Date(tripInfo.startDate);
                startDate.setDate(startDate.getDate() + tripData.length);
                newDate = startDate.toISOString().split('T')[0];
            }

            const newDay = {
                day: tripData.length + 1,
                date: newDate,
                location: '',
                transportType: 'Bus',
                transportFrom: '',
                transportTo: '',
                transportTime: '',
                transportCost: 0,
                accommodationType: 'Hostel',
                accommodationName: '',
                accommodationCost: 0,
                notes: ''
            };
            
            tripData.push(newDay);
            saveToStorage();
            updateDaysList();
            updateAllUI();
            updateDocumentDayOptions();
            showToast('‚úÖ New day added!', 'success');
        }

        function addMultipleDays() {
            const count = parseInt(document.getElementById('daysToAdd').value) || 1;
            
            if (!validateLimits('days', count)) return;

            for (let i = 0; i < count; i++) {
                addNewDay();
            }
            showToast(`‚úÖ Added ${count} days!`, 'success');
        }

        function duplicateDay() {
            if (tripData.length === 0) {
                showToast('‚ùå No days to duplicate!', 'error');
                return;
            }

            if (!validateLimits('days')) return;

            const lastDay = tripData[tripData.length - 1];
            const duplicatedDay = { ...lastDay };
            duplicatedDay.day = tripData.length + 1;
            duplicatedDay.date = '';
            
            tripData.push(duplicatedDay);
            saveToStorage();
            updateDaysList();
            updateAllUI();
            showToast('‚úÖ Day duplicated!', 'success');
        }

        function clearAllDays() {
            if (tripData.length === 0) {
                showToast('‚ùå No days to clear!', 'error');
                return;
            }

            if (confirm(`Are you sure you want to delete all ${tripData.length} days? This cannot be undone.`)) {
                tripData = [];
                saveToStorage();
                updateDaysList();
                updateAllUI();
                updateDocumentDayOptions();
                showToast('‚úÖ All days cleared!', 'success');
            }
        }

        function deleteDay(index) {
            if (confirm('Delete this day? This cannot be undone.')) {
                tripData.splice(index, 1);
                // Renumber days
                tripData.forEach((day, i) => day.day = i + 1);
                saveToStorage();
                updateDaysList();
                updateAllUI();
                updateDocumentDayOptions();
                showToast('‚úÖ Day deleted!', 'success');
            }
        }

        function copyDay(index) {
            if (!validateLimits('days')) return;

            const originalDay = { ...tripData[index] };
            originalDay.day = tripData.length + 1;
            originalDay.date = '';
            tripData.push(originalDay);
            saveToStorage();
            updateDaysList();
            updateAllUI();
            updateDocumentDayOptions();
            showToast('‚úÖ Day copied!', 'success');
        }

        function updateDayData(index, field, value) {
            if (tripData[index]) {
                if (field === 'transportCost' || field === 'accommodationCost') {
                    value = Math.max(0, parseFloat(value) || 0);
                }
                tripData[index][field] = value;
                saveToStorage();
                updateAllUI();
            }
        }

        function filterDays(filter) {
            currentFilter = filter;
            currentPage = 1;
            updateDaysList();
        }

        function sortDays(sortBy) {
            switch(sortBy) {
                case 'date':
                    tripData.sort((a, b) => {
                        if (!a.date && !b.date) return a.day - b.day;
                        if (!a.date) return 1;
                        if (!b.date) return -1;
                        return new Date(a.date) - new Date(b.date);
                    });
                    break;
                case 'cost':
                    tripData.sort((a, b) => {
                        const costA = (a.transportCost || 0) + (a.accommodationCost || 0);
                        const costB = (b.transportCost || 0) + (b.accommodationCost || 0);
                        return costB - costA;
                    });
                    break;
                case 'completion':
                    tripData.sort((a, b) => calculateDayCompletion(b) - calculateDayCompletion(a));
                    break;
            }
            
            // Renumber days after sorting
            tripData.forEach((day, i) => day.day = i + 1);
            saveToStorage();
            updateDaysList();
            showToast(`‚úÖ Days sorted by ${sortBy}!`, 'success');
        }

        function updateDaysList() {
            const container = document.getElementById('daysList');
            
            if (tripData.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <div>
                            <strong>üåü Ready to start planning?</strong><br>
                            Click "Add Day" above to create your first day, or use "Generate Suggestions" in the Overview tab to auto-create days from your destinations!
                        </div>
                    </div>
                `;
                document.getElementById('daysPagination').innerHTML = '';
                return;
            }

            // Filter days
            let filteredDays = tripData;
            switch(currentFilter) {
                case 'incomplete':
                    filteredDays = tripData.filter(day => calculateDayCompletion(day) < 0.8);
                    break;
                case 'complete':
                    filteredDays = tripData.filter(day => calculateDayCompletion(day) >= 0.8);
                    break;
            }

            // Pagination
            const totalPages = Math.ceil(filteredDays.length / LIMITS.ITEMS_PER_PAGE);
            const startIndex = (currentPage - 1) * LIMITS.ITEMS_PER_PAGE;
            const endIndex = startIndex + LIMITS.ITEMS_PER_PAGE;
            const paginatedDays = filteredDays.slice(startIndex, endIndex);

            // Update day count
            document.getElementById('dayCount').textContent = tripData.length;

            container.innerHTML = paginatedDays.map((day, index) => {
                const actualIndex = tripData.indexOf(day);
                const dayCost = (day.transportCost || 0) + (day.accommodationCost || 0);
                const completion = calculateDayCompletion(day);
                const progressClass = completion >= 0.8 ? 'progress-high' : completion >= 0.4 ? 'progress-medium' : 'progress-low';
                const progressPercent = Math.round(completion * 100);
                
                return `
                    <div class="day-card slide-up" style="animation-delay: ${index * 0.1}s">
                        <div class="progress-indicator ${progressClass}">${progressPercent}%</div>
                        
                        <div class="day-header">
                            <div class="day-title">üìç Day ${day.day} - ${day.location || 'Location TBD'}</div>
                            <div class="day-cost">¬£${dayCost.toFixed(2)}</div>
                        </div>
                        
                        <div class="row">
                            <div class="col">
                                <div class="form-group">
                                    <label>üìÖ Date</label>
                                    <input type="date" value="${day.date || ''}" onchange="updateDayData(${actualIndex}, 'date', this.value)">
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">
                                    <label>üìç Location</label>
                                    <input type="text" value="${day.location || ''}" placeholder="e.g., Paris, Bangkok" onchange="updateDayData(${actualIndex}, 'location', this.value)" maxlength="50">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col">
                                <div class="collapsible">
                                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                                        <span>üöå Transportation</span>
                                        <span class="collapsible-toggle">‚ñº</span>
                                    </div>
                                    <div class="collapsible-content">
                                        <div class="form-group">
                                            <label>Type</label>
                                            <select onchange="updateDayData(${actualIndex}, 'transportType', this.value)">
                                                <option value="Bus" ${day.transportType === 'Bus' ? 'selected' : ''}>üöå Bus</option>
                                                <option value="Train" ${day.transportType === 'Train' ? 'selected' : ''}>üöÇ Train</option>
                                                <option value="Plane" ${day.transportType === 'Plane' ? 'selected' : ''}>‚úàÔ∏è Plane</option>
                                                <option value="Ferry" ${day.transportType === 'Ferry' ? 'selected' : ''}>‚õ¥Ô∏è Ferry</option>
                                                <option value="Car/Taxi" ${day.transportType === 'Car/Taxi' ? 'selected' : ''}>üöó Car/Taxi</option>
                                                <option value="Walking" ${day.transportType === 'Walking' ? 'selected' : ''}>üö∂ Walking</option>
                                                <option value="Local Transport" ${day.transportType === 'Local Transport' ? 'selected' : ''}>üöä Local Transport</option>
                                                <option value="Cycling" ${day.transportType === 'Cycling' ? 'selected' : ''}>üö¥ Cycling</option>
                                            </select>
                                        </div>
                                        <div class="row">
                                            <div class="col">
                                                <div class="form-group">
                                                    <label>From</label>
                                                    <input type="text" value="${day.transportFrom || ''}" placeholder="Departure" onchange="updateDayData(${actualIndex}, 'transportFrom', this.value)" maxlength="50">
                                                </div>
                                            </div>
                                            <div class="col">
                                                <div class="form-group">
                                                    <label>To</label>
                                                    <input type="text" value="${day.transportTo || ''}" placeholder="Arrival" onchange="updateDayData(${actualIndex}, 'transportTo', this.value)" maxlength="50">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col">
                                                <div class="form-group">
                                                    <label>Time</label>
                                                    <input type="text" value="${day.transportTime || ''}" placeholder="09:30" onchange="updateDayData(${actualIndex}, 'transportTime', this.value)" maxlength="20">
                                                </div>
                                            </div>
                                            <div class="col">
                                                <div class="form-group">
                                                    <label>Cost (¬£)</label>
                                                    <input type="number" value="${day.transportCost || 0}" min="0" max="10000" step="1" onchange="updateDayData(${actualIndex}, 'transportCost', this.value)">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col">
                                <div class="collapsible">
                                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                                        <span>üè® Accommodation</span>
                                        <span class="collapsible-toggle">‚ñº</span>
                                    </div>
                                    <div class="collapsible-content">
                                        <div class="form-group">
                                            <label>Type</label>
                                            <select onchange="updateDayData(${actualIndex}, 'accommodationType', this.value)">
                                                <option value="Hostel" ${day.accommodationType === 'Hostel' ? 'selected' : ''}>üè† Hostel</option>
                                                <option value="Hotel" ${day.accommodationType === 'Hotel' ? 'selected' : ''}>üè® Hotel</option>
                                                <option value="Guesthouse" ${day.accommodationType === 'Guesthouse' ? 'selected' : ''}>üè° Guesthouse</option>
                                                <option value="Camping" ${day.accommodationType === 'Camping' ? 'selected' : ''}>‚õ∫ Camping</option>
                                                <option value="Bus (sleeping)" ${day.accommodationType === 'Bus (sleeping)' ? 'selected' : ''}>üöå Bus (sleeping)</option>
                                                <option value="Train (sleeping)" ${day.accommodationType === 'Train (sleeping)' ? 'selected' : ''}>üöÇ Train (sleeping)</option>
                                                <option value="Airbnb" ${day.accommodationType === 'Airbnb' ? 'selected' : ''}>üè† Airbnb</option>
                                                <option value="Couchsurfing" ${day.accommodationType === 'Couchsurfing' ? 'selected' : ''}>üõãÔ∏è Couchsurfing</option>
                                                <option value="Friend's place" ${day.accommodationType === "Friend's place" ? 'selected' : ''}>üë• Friend's place</option>
                                                <option value="None (transit day)" ${day.accommodationType === 'None (transit day)' ? 'selected' : ''}>üö∂ None (transit day)</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Name</label>
                                            <input type="text" value="${day.accommodationName || ''}" placeholder="Hotel/Hostel name" onchange="updateDayData(${actualIndex}, 'accommodationName', this.value)" maxlength="100">
                                        </div>
                                        <div class="form-group">
                                            <label>Cost (¬£)</label>
                                            <input type="number" value="${day.accommodationCost || 0}" min="0" max="1000" step="1" onchange="updateDayData(${actualIndex}, 'accommodationCost', this.value)">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>üìù Notes & Activities</label>
                            <textarea rows="3" placeholder="Things to do, places to visit..." onchange="updateDayData(${actualIndex}, 'notes', this.value)" maxlength="500">${day.notes || ''}</textarea>
                        </div>
                        
                        <div class="row" style="align-items: center; margin-top: 1rem;">
                            <div class="col">
                                <button class="btn btn-danger btn-sm" onclick="deleteDay(${actualIndex})">üóëÔ∏è Delete</button>
                                <button class="btn btn-secondary btn-sm" onclick="copyDay(${actualIndex})">üìã Copy</button>
                                <button class="btn btn-info btn-sm" onclick="addDocumentForDay(${day.day})">üìÑ Add Doc</button>
                            </div>
                            <div class="col-auto">
                                <div style="text-align: right;">
                                    <small>Completion: ${progressPercent}%</small>
                                    <div class="progress-bar" style="width: 100px;">
                                        <div class="progress-fill" style="width: ${progressPercent}%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Update pagination
            updatePagination(totalPages, 'daysPagination');
        }

        function updatePagination(totalPages, containerId) {
            const container = document.getElementById(containerId);
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let paginationHTML = '';
            
            // Previous button
            if (currentPage > 1) {
                paginationHTML += `<button onclick="changePage(${currentPage - 1})">‚óÄ Previous</button>`;
            }
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage || i === 1 || i === totalPages || 
                    (i >= currentPage - 1 && i <= currentPage + 1)) {
                    paginationHTML += `<button class="${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    paginationHTML += '<span>...</span>';
                }
            }
            
            // Next button
            if (currentPage < totalPages) {
                paginationHTML += `<button onclick="changePage(${currentPage + 1})">Next ‚ñ∂</button>`;
            }
            
            container.innerHTML = paginationHTML;
        }

        function changePage(page) {
            currentPage = page;
            updateDaysList();
        }

        function calculateDayCompletion(day) {
            const requiredFields = ['location', 'transportFrom', 'transportTo', 'accommodationType'];
            const optionalFields = ['date', 'transportTime', 'accommodationName', 'notes'];
            
            const requiredCompleted = requiredFields.filter(field => day[field] && day[field].trim() !== '').length;
            const requiredScore = (requiredCompleted / requiredFields.length) * 0.7;
            
            const optionalCompleted = optionalFields.filter(field => day[field] && day[field].trim() !== '').length;
            const optionalScore = (optionalCompleted / optionalFields.length) * 0.3;
            
            return requiredScore + optionalScore;
        }

        // Enhanced Document Functions
        function updateDocumentDayOptions() {
            const select = document.getElementById('documentDay');
            select.innerHTML = '<option value="">Select Day</option>';
            
            tripData.forEach(day => {
                const option = document.createElement('option');
                option.value = day.day;
                option.textContent = `Day ${day.day} - ${day.location || 'TBD'}`;
                select.appendChild(option);
            });
        }

        function addDocumentForDay(dayNumber) {
            showTab('documents');
            document.getElementById('documentDay').value = dayNumber;
            const collapsible = document.querySelector('#documents .collapsible-header');
            if (!collapsible.parentElement.classList.contains('active')) {
                toggleCollapsible(collapsible);
            }
        }

        async function addDocument() {
            if (!validateLimits('documents')) return;

            const day = document.getElementById('documentDay').value;
            const type = document.getElementById('documentType').value;
            const name = document.getElementById('documentName').value.trim();
            const details = document.getElementById('documentDetails').value.trim();
            const status = document.getElementById('documentStatus').value;
            const fileInput = document.getElementById('documentFile');

            if (!day || !name) {
                if (!day) {
                    showToast('‚ùå Please select a day first! Add some days in the Planning tab if needed.', 'error');
                } else {
                    showToast('‚ùå Please enter a document name!', 'error');
                }
                return;
            }

            let fileData = null;
            if (fileInput.files && fileInput.files[0]) {
                const file = fileInput.files[0];
                
                if (file.size > LIMITS.MAX_FILE_SIZE) {
                    showToast(`‚ùå File size too large! Maximum ${LIMITS.MAX_FILE_SIZE / (1024 * 1024)}MB allowed.`, 'error');
                    return;
                }

                try {
                    const base64 = await fileToBase64(file);
                    fileData = {
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: base64
                    };
                } catch (error) {
                    showToast('‚ùå Error reading file. Please try again.', 'error');
                    return;
                }
            }

            const newDocument = {
                id: Date.now(),
                day: parseInt(day),
                type,
                name,
                details,
                status,
                file: fileData,
                dateAdded: new Date().toISOString()
            };

            documentsData.push(newDocument);
            saveToStorage();
            updateDocumentsView();
            updateAllUI();

            // Clear form
            ['documentDay', 'documentName', 'documentDetails', 'documentFile'].forEach(id => {
                const element = document.getElementById(id);
                if (element) element.value = '';
            });
            document.getElementById('documentStatus').value = 'pending';

            showToast('‚úÖ Document added successfully!', 'success');
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        function updateDocumentsView() {
            updateDocumentDayOptions();
            document.getElementById('docCount').textContent = documentsData.length;
            
            const container = document.getElementById('documentsContainer');
            
            if (tripData.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <div>
                            <strong>‚ö†Ô∏è No days planned yet!</strong><br>
                            Go to the <strong>Planning</strong> tab first to add some days to your itinerary, then come back here to add documents for each day.
                        </div>
                    </div>
                `;
                return;
            }
            
            if (documentsData.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <div>
                            <strong>üìÑ No documents added yet</strong><br>
                            Add your first ticket, reservation, or important document using the form above!
                        </div>
                    </div>
                `;
                return;
            }

            // Group documents by day
            const groupedDocs = {};
            documentsData.forEach(doc => {
                if (!groupedDocs[doc.day]) {
                    groupedDocs[doc.day] = [];
                }
                groupedDocs[doc.day].push(doc);
            });

            let html = '';
            Object.keys(groupedDocs).sort((a, b) => parseInt(a) - parseInt(b)).forEach(day => {
                const dayData = tripData.find(d => d.day === parseInt(day));
                const dayLocation = dayData ? dayData.location || 'TBD' : 'TBD';
                
                html += `
                    <div class="collapsible active">
                        <div class="collapsible-header" onclick="toggleCollapsible(this)">
                            <span>üìÖ Day ${day} - ${dayLocation} (${groupedDocs[day].length} docs)</span>
                            <span class="collapsible-toggle">‚ñº</span>
                        </div>
                        <div class="collapsible-content">
                            ${groupedDocs[day].map(doc => `
                                <div class="card" style="margin-bottom: 1rem; padding: 1rem; ${getDocumentStatusStyle(doc.status)}">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem;">
                                        <div style="flex: 1;">
                                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                                <strong style="font-size: 1.1rem;">${doc.type}</strong>
                                                <span class="badge ${getStatusClass(doc.status)}">${getStatusText(doc.status)}</span>
                                            </div>
                                            <h4 style="margin-bottom: 0.5rem; color: #333;">${doc.name}</h4>
                                            ${doc.details ? `<p style="color: var(--text-muted); margin-bottom: 0.5rem;">${doc.details}</p>` : ''}
                                            ${doc.file ? `
                                                <div style="margin-top: 0.75rem; padding: 0.5rem; background: var(--light-bg); border-radius: 6px;">
                                                    <div style="display: flex; align-items: center; justify-content: space-between; gap: 1rem;">
                                                        <span style="font-size: 0.9rem; color: #495057;">
                                                            üìé ${doc.file.name} (${formatFileSize(doc.file.size)})
                                                        </span>
                                                        <div>
                                                            <button class="btn btn-info btn-sm" onclick="previewFile(${doc.id})">üëÅÔ∏è Preview</button>
                                                            <button class="btn btn-primary btn-sm" onclick="downloadFile(${doc.id})">üì• Download</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ` : ''}
                                            <small style="color: var(--text-muted); margin-top: 0.5rem; display: block;">
                                                Added: ${new Date(doc.dateAdded).toLocaleDateString()}
                                            </small>
                                        </div>
                                        <div style="display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-end;">
                                            <select onchange="updateDocumentStatus(${doc.id}, this.value)" style="padding: 0.25rem; font-size: 0.9rem;">
                                                <option value="pending" ${doc.status === 'pending' ? 'selected' : ''}>üü° Pending</option>
                                                <option value="confirmed" ${doc.status === 'confirmed' ? 'selected' : ''}>üü¢ Confirmed</option>
                                                <option value="cancelled" ${doc.status === 'cancelled' ? 'selected' : ''}>üî¥ Cancelled</option>
                                            </select>
                                            <button class="btn btn-danger btn-sm" onclick="deleteDocument(${doc.id})" title="Delete document">üóëÔ∏è</button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function getDocumentStatusStyle(status) {
            switch(status) {
                case 'confirmed': return 'border-left: 4px solid var(--success-color);';
                case 'cancelled': return 'border-left: 4px solid var(--danger-color);';
                default: return 'border-left: 4px solid var(--warning-color);';
            }
        }

        function getStatusClass(status) {
            switch(status) {
                case 'confirmed': return 'badge-success';
                case 'cancelled': return 'badge-danger';
                default: return 'badge-warning';
            }
        }

        function getStatusText(status) {
            switch(status) {
                case 'confirmed': return '‚úÖ Confirmed';
                case 'cancelled': return '‚ùå Cancelled';
                default: return '‚è≥ Pending';
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function deleteDocument(id) {
            if (confirm('Delete this document? This cannot be undone.')) {
                documentsData = documentsData.filter(doc => doc.id !== id);
                saveToStorage();
                updateDocumentsView();
                updateAllUI();
                showToast('‚úÖ Document deleted!', 'success');
            }
        }

        function updateDocumentStatus(id, newStatus) {
            const doc = documentsData.find(d => d.id === id);
            if (doc) {
                doc.status = newStatus;
                saveToStorage();
                updateDocumentsView();
                updateAllUI();
                showToast(`‚úÖ Document status updated to ${newStatus}!`, 'success');
            }
        }

        function downloadFile(docId) {
            const doc = documentsData.find(d => d.id === docId);
            if (!doc || !doc.file) return;

            const link = document.createElement('a');
            link.href = doc.file.data;
            link.download = doc.file.name;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('‚úÖ File downloaded!', 'success');
        }

        function previewFile(docId) {
            const doc = documentsData.find(d => d.id === docId);
            if (!doc || !doc.file) return;

            const fileType = doc.file.type;
            let previewContent = '';

            if (fileType.startsWith('image/')) {
                previewContent = `<img src="${doc.file.data}" style="max-width: 100%; max-height: 500px; object-fit: contain; border-radius: 8px;">`;
            } else if (fileType === 'application/pdf') {
                previewContent = `<iframe src="${doc.file.data}" style="width: 100%; height: 500px; border: none; border-radius: 8px;"></iframe>`;
            } else if (fileType.startsWith('text/')) {
                previewContent = `<div style="padding: 1rem; background: var(--light-bg); border-radius: 8px; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto;">Text file preview not available in this demo.<br><a href="${doc.file.data}" download="${doc.file.name}" class="btn btn-primary btn-sm">Download to view</a></div>`;
            } else {
                previewContent = `<div style="text-align: center; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üìÑ</div>
                    <p>Preview not available for this file type.</p>
                    <a href="${doc.file.data}" download="${doc.file.name}" class="btn btn-primary">üì• Download to view</a>
                </div>`;
            }

            showModal(doc.file.name, previewContent);
        }

        // Enhanced Todo Functions
        function addTodo() {
            if (!validateLimits('todos')) return;

            const title = document.getElementById('todoTitle').value.trim();
            const description = document.getElementById('todoDescription').value.trim();
            const priority = document.getElementById('todoPriority').value;
            const dueDate = document.getElementById('todoDueDate').value;
            const category = document.getElementById('todoCategory').value;

            if (!title) {
                showToast('‚ùå Please enter a task title!', 'error');
                return;
            }

            const newTodo = {
                id: Date.now(),
                title,
                description,
                priority,
                dueDate,
                category,
                completed: false,
                dateAdded: new Date().toISOString(),
                dateCompleted: null
            };

            todosData.push(newTodo);
            saveToStorage();
            updateTodosView();
            updateAllUI();

            // Clear form
            ['todoTitle', 'todoDescription', 'todoDueDate'].forEach(id => {
                document.getElementById(id).value = '';
            });

            showToast('‚úÖ Task added successfully!', 'success');
        }

        function deleteTodo(id) {
            if (confirm('Delete this task? This cannot be undone.')) {
                todosData = todosData.filter(todo => todo.id !== id);
                saveToStorage();
                updateTodosView();
                updateAllUI();
                showToast('‚úÖ Task deleted!', 'success');
            }
        }

        function toggleTodoComplete(id) {
            const todo = todosData.find(t => t.id === id);
            if (todo) {
                todo.completed = !todo.completed;
                todo.dateCompleted = todo.completed ? new Date().toISOString() : null;
                saveToStorage();
                updateTodosView();
                updateAllUI();
                
                const message = todo.completed ? '‚úÖ Task completed!' : '‚è≥ Task marked as pending';
                showToast(message, 'success');
            }
        }

        function filterTodos(filter) {
            currentTodoFilter = filter;
            updateTodosView();
        }

        function updateTodosView() {
            document.getElementById('taskCount').textContent = todosData.length;
            
            const container = document.getElementById('todosContainer');
            
            if (todosData.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <div>
                            <strong>‚úÖ No tasks added yet</strong><br>
                            Add your first task using the form above to start organizing your trip preparation!
                        </div>
                    </div>
                `;
                document.getElementById('todoStats').innerHTML = '';
                return;
            }

            // Update stats
            const totalTasks = todosData.length;
            const completedTasks = todosData.filter(t => t.completed).length;
            const pendingTasks = totalTasks - completedTasks;
            const highPriorityTasks = todosData.filter(t => t.priority === 'high' && !t.completed).length;
            const overdueTasks = todosData.filter(t => {
                if (!t.dueDate || t.completed) return false;
                return new Date(t.dueDate) < new Date();
            }).length;

            document.getElementById('todoStats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${totalTasks}</div>
                    <div class="stat-label">üìã Total Tasks</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${completedTasks}</div>
                    <div class="stat-label">‚úÖ Completed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${pendingTasks}</div>
                    <div class="stat-label">‚è≥ Pending</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${highPriorityTasks}</div>
                    <div class="stat-label">üî¥ High Priority</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${overdueTasks}</div>
                    <div class="stat-label">‚ö†Ô∏è Overdue</div>
                </div>
            `;

            // Filter todos
            let filteredTodos = todosData;
            switch(currentTodoFilter) {
                case 'pending':
                    filteredTodos = todosData.filter(t => !t.completed);
                    break;
                case 'completed':
                    filteredTodos = todosData.filter(t => t.completed);
                    break;
                case 'high':
                    filteredTodos = todosData.filter(t => t.priority === 'high');
                    break;
                case 'overdue':
                    filteredTodos = todosData.filter(t => {
                        if (!t.dueDate || t.completed) return false;
                        return new Date(t.dueDate) < new Date();
                    });
                    break;
            }

            // Sort todos: incomplete high priority first, then by due date
            filteredTodos.sort((a, b) => {
                if (a.completed !== b.completed) return a.completed - b.completed;
                if (a.priority !== b.priority) {
                    const priorityOrder = { 'high': 0, 'medium': 1, 'low': 2 };
                    return priorityOrder[a.priority] - priorityOrder[b.priority];
                }
                if (a.dueDate && b.dueDate) return new Date(a.dueDate) - new Date(b.dueDate);
                return 0;
            });

            const html = filteredTodos.map((todo, index) => {
                const isOverdue = todo.dueDate && !todo.completed && new Date(todo.dueDate) < new Date();
                const dueDateStr = todo.dueDate ? new Date(todo.dueDate).toLocaleDateString() : '';
                const priorityClass = `priority-${todo.priority}`;
                
                return `
                    <div class="card slide-up ${todo.completed ? 'completed' : ''}" style="animation-delay: ${index * 0.05}s; margin-bottom: 1rem; ${todo.completed ? 'opacity: 0.7;' : ''} ${isOverdue ? 'border-left: 4px solid var(--danger-color);' : ''}">
                        <div style="display: flex; align-items: flex-start; gap: 1rem;">
                            <input type="checkbox" ${todo.completed ? 'checked' : ''} onchange="toggleTodoComplete(${todo.id})" style="transform: scale(1.3); margin-top: 0.25rem;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; flex-wrap: wrap;">
                                    <h4 style="margin: 0; ${todo.completed ? 'text-decoration: line-through; opacity: 0.6;' : ''}">${todo.title}</h4>
                                    <span class="badge ${priorityClass}">${todo.priority.toUpperCase()}</span>
                                    <span class="badge badge-info" style="font-size: 0.8rem;">${todo.category}</span>
                                </div>
                                ${todo.description ? `<p style="color: var(--text-muted); margin-bottom: 0.5rem; ${todo.completed ? 'opacity: 0.6;' : ''}">${todo.description}</p>` : ''}
                                <div style="display: flex; gap: 1rem; flex-wrap: wrap; font-size: 0.9rem; color: var(--text-muted);">
                                    ${todo.dueDate ? `<span style="color: ${isOverdue ? 'var(--danger-color)' : 'var(--text-muted)'};">${isOverdue ? '‚ö†Ô∏è Overdue: ' : 'üìÖ Due: '}${dueDateStr}</span>` : ''}
                                    <span>Added: ${new Date(todo.dateAdded).toLocaleDateString()}</span>
                                    ${todo.dateCompleted ? `<span style="color: var(--success-color);">‚úÖ Completed: ${new Date(todo.dateCompleted).toLocaleDateString()}</span>` : ''}
                                </div>
                            </div>
                            <button class="btn btn-danger btn-sm" onclick="deleteTodo(${todo.id})" title="Delete task">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html || '<div class="alert alert-info"><div>No tasks match the current filter.</div></div>';
        }

        // Enhanced Budget Functions
        function updateBudgetOverview() {
            const totalTransport = tripData.reduce((sum, day) => sum + (day.transportCost || 0), 0);
            const totalAccommodation = tripData.reduce((sum, day) => sum + (day.accommodationCost || 0), 0);
            
            const dailyCosts = (budgetData.foodBudget + budgetData.activitiesBudget + budgetData.localTransportBudget) * tripData.length;
            const oneTimeCosts = budgetData.shoppingBudget + budgetData.gearBudget + budgetData.miscBudget;
            const safetyFunds = budgetData.emergencyBudget + budgetData.insuranceBudget + budgetData.visaBudget;
            
            const totalPlanned = totalTransport + totalAccommodation + dailyCosts + oneTimeCosts + safetyFunds;
            const remaining = budgetData.totalBudget - totalPlanned;
            const percentage = budgetData.totalBudget > 0 ? (totalPlanned / budgetData.totalBudget * 100) : 0;

            document.getElementById('budgetOverview').innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">¬£${budgetData.totalBudget.toFixed(0)}</div>
                    <div class="stat-label">üí∞ Total Budget</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">¬£${totalPlanned.toFixed(0)}</div>
                    <div class="stat-label">üìù Planned</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">¬£${remaining.toFixed(0)}</div>
                    <div class="stat-label">üí∏ Remaining</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${percentage.toFixed(1)}%</div>
                    <div class="stat-label">üìà Used</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">¬£${tripData.length > 0 ? (totalPlanned / tripData.length).toFixed(0) : 0}</div>
                    <div class="stat-label">üìä Daily Average</div>
                </div>
            `;

            // Budget analysis
            let analysisHTML = '';
            
            if (remaining < 0) {
                analysisHTML += `<div class="alert alert-error">üí∏ Over budget by ¬£${Math.abs(remaining).toFixed(0)}! Consider reducing expenses or increasing budget.</div>`;
            } else if (remaining < budgetData.totalBudget * 0.1) {
                analysisHTML += `<div class="alert alert-warning">üî∂ Cutting it close with budget! Only ¬£${remaining.toFixed(0)} remaining.</div>`;
            } else {
                analysisHTML += `<div class="alert alert-success">‚úÖ Within budget! You have ¬£${remaining.toFixed(0)} remaining for unexpected expenses.</div>`;
            }

            // Budget breakdown
            analysisHTML += `
                <div class="row" style="margin-top: 2rem;">
                    <div class="col">
                        <h4>üí∞ Budget Breakdown</h4>
                        <div class="progress-bar" style="margin: 0.5rem 0;">
                            <div class="progress-fill" style="width: ${(totalTransport / budgetData.totalBudget * 100)}%; background: #007bff;"></div>
                        </div>
                        <small>Transport: ¬£${totalTransport.toFixed(0)} (${(totalTransport / budgetData.totalBudget * 100).toFixed(1)}%)</small>
                        
                        <div class="progress-bar" style="margin: 0.5rem 0;">
                            <div class="progress-fill" style="width: ${(totalAccommodation / budgetData.totalBudget * 100)}%; background: #28a745;"></div>
                        </div>
                        <small>Accommodation: ¬£${totalAccommodation.toFixed(0)} (${(totalAccommodation / budgetData.totalBudget * 100).toFixed(1)}%)</small>
                        
                        <div class="progress-bar" style="margin: 0.5rem 0;">
                            <div class="progress-fill" style="width: ${(dailyCosts / budgetData.totalBudget * 100)}%; background: #ffc107;"></div>
                        </div>
                        <small>Daily Expenses: ¬£${dailyCosts.toFixed(0)} (${(dailyCosts / budgetData.totalBudget * 100).toFixed(1)}%)</small>
                        
                        <div class="progress-bar" style="margin: 0.5rem 0;">
                            <div class="progress-fill" style="width: ${(safetyFunds / budgetData.totalBudget * 100)}%; background: #dc3545;"></div>
                        </div>
                        <small>Safety & Insurance: ¬£${safetyFunds.toFixed(0)} (${(safetyFunds / budgetData.totalBudget * 100).toFixed(1)}%)</small>
                    </div>
                    <div class="col">
                        <h4>üí° Budget Recommendations</h4>
                        ${generateBudgetRecommendations(totalPlanned, remaining, budgetData.totalBudget)}
                    </div>
                </div>
            `;
            
            document.getElementById('budgetAnalysis').innerHTML = analysisHTML;
        }

        function generateBudgetRecommendations(totalPlanned, remaining, totalBudget) {
            let recommendations = [];
            
            if (remaining < 0) {
                recommendations.push('üî¥ Consider reducing accommodation costs by choosing hostels over hotels');
                recommendations.push('üî¥ Look for budget transport options like buses instead of flights');
                recommendations.push('üî¥ Reduce daily food budget by cooking or eating at local places');
            } else if (remaining < totalBudget * 0.1) {
                recommendations.push('üü° Keep an eye on daily expenses to stay within budget');
                recommendations.push('üü° Book accommodations in advance for better rates');
                recommendations.push('üü° Consider travel insurance to protect your investment');
            } else {
                recommendations.push('üü¢ Great job staying within budget!');
                recommendations.push('üü¢ Consider adding a buffer for unexpected experiences');
                recommendations.push('üü¢ You might have room for some upgrades or activities');
            }
            
            if (budgetData.emergencyBudget < totalBudget * 0.1) {
                recommendations.push('üí° Consider allocating 10-15% of budget for emergencies');
            }
            
            return recommendations.map(rec => `<p style="margin-bottom: 0.5rem;">${rec}</p>`).join('');
        }

        // Enhanced Analytics Functions
        function updateAnalytics() {
            if (tripData.length === 0 && documentsData.length === 0 && todosData.length === 0) {
                document.getElementById('analyticsContent').innerHTML = `
                    <div class="alert alert-info">
                        <div>
                            <strong>üìä No data to analyze yet</strong><br>
                            Add some trip days, documents, or tasks to see detailed analytics and insights!
                        </div>
                    </div>
                `;
                return;
            }

            const completedDays = tripData.filter(day => calculateDayCompletion(day) >= 0.8).length;
            const completionRate = tripData.length > 0 ? completedDays / tripData.length : 0;
            const confirmedDocs = documentsData.filter(doc => doc.status === 'confirmed').length;
            const completedTodos = todosData.filter(todo => todo.completed).length;

            // Calculate travel patterns
            const transportStats = {};
            const accommodationStats = {};
            const costByDay = [];
            
            tripData.forEach(day => {
                const transport = day.transportType || 'Unknown';
                const accommodation = day.accommodationType || 'Unknown';
                const dayCost = (day.transportCost || 0) + (day.accommodationCost || 0);
                
                transportStats[transport] = (transportStats[transport] || 0) + 1;
                accommodationStats[accommodation] = (accommodationStats[accommodation] || 0) + 1;
                costByDay.push(dayCost);
            });

            const totalCost = costByDay.reduce((sum, cost) => sum + cost, 0);
            const avgDailyCost = costByDay.length > 0 ? totalCost / costByDay.length : 0;
            const maxDailyCost = Math.max(...costByDay, 0);
            const minDailyCost = Math.min(...costByDay.filter(c => c > 0), 0) || 0;

            document.getElementById('analyticsContent').innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${completedDays}/${tripData.length}</div>
                        <div class="stat-label">üèÅ Completed Days</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${(completionRate * 100).toFixed(1)}%</div>
                        <div class="stat-label">üìà Planning Progress</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${confirmedDocs}/${documentsData.length}</div>
                        <div class="stat-label">üìÑ Confirmed Docs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${completedTodos}/${todosData.length}</div>
                        <div class="stat-label">‚úÖ Tasks Done</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">¬£${avgDailyCost.toFixed(0)}</div>
                        <div class="stat-label">üìä Avg Daily Cost</div>
                    </div>
                </div>
                
                <div class="progress-bar" style="margin: 1rem 0;">
                    <div class="progress-fill" style="width: ${completionRate * 100}%"></div>
                </div>
                <p style="text-align: center; margin-bottom: 2rem;">Overall Trip Planning: ${(completionRate * 100).toFixed(1)}%</p>
                
                <div class="row">
                    <div class="col">
                        <div class="card" style="padding: 1.5rem;">
                            <h4>üöå Transport Analysis</h4>
                            ${Object.entries(transportStats).length > 0 ? 
                                Object.entries(transportStats).map(([type, count]) => 
                                    `<div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <span>${getTransportEmoji(type)} ${type}</span>
                                        <strong>${count} journey${count !== 1 ? 's' : ''}</strong>
                                    </div>`
                                ).join('') :
                                '<p style="color: var(--text-muted);">No transport data yet</p>'
                            }
                        </div>
                    </div>
                    
                    <div class="col">
                        <div class="card" style="padding: 1.5rem;">
                            <h4>üè® Accommodation Analysis</h4>
                            ${Object.entries(accommodationStats).length > 0 ? 
                                Object.entries(accommodationStats).map(([type, count]) => 
                                    `<div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <span>${getAccommodationEmoji(type)} ${type}</span>
                                        <strong>${count} night${count !== 1 ? 's' : ''}</strong>
                                    </div>`
                                ).join('') :
                                '<p style="color: var(--text-muted);">No accommodation data yet</p>'
                            }
                        </div>
                    </div>
                </div>
                
                <div class="row" style="margin-top: 2rem;">
                    <div class="col">
                        <div class="card" style="padding: 1.5rem;">
                            <h4>üí∞ Cost Analysis</h4>
                            <div style="margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Total Cost:</span>
                                    <strong>¬£${totalCost.toFixed(2)}</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Average per Day:</span>
                                    <strong>¬£${avgDailyCost.toFixed(2)}</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Highest Day:</span>
                                    <strong>¬£${maxDailyCost.toFixed(2)}</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Lowest Day:</span>
                                    <strong>¬£${minDailyCost.toFixed(2)}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col">
                        <div class="card" style="padding: 1.5rem;">
                            <h4>üìà Progress Insights</h4>
                            ${generateProgressInsights(completionRate, confirmedDocs, documentsData.length, completedTodos, todosData.length)}
                        </div>
                    </div>
                </div>
                
                ${tripData.length > 0 ? `
                    <div style="margin-top: 2rem;">
                        <h4>üìÖ Daily Cost Visualization</h4>
                        <div class="row">
                            ${tripData.map((day, index) => {
                                const cost = (day.transportCost || 0) + (day.accommodationCost || 0);
                                const heightPercent = maxDailyCost > 0 ? (cost / maxDailyCost * 100) : 0;
                                return `
                                    <div class="col" style="min-width: 80px; margin-bottom: 1rem;">
                                        <div style="text-align: center;">
                                            <div style="height: 100px; display: flex; align-items: flex-end; justify-content: center; margin-bottom: 0.5rem;">
                                                <div style="width: 30px; background: var(--primary-gradient); height: ${heightPercent}%; min-height: 2px; border-radius: 4px; position: relative;">
                                                    <div style="position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 0.8rem; white-space: nowrap;">¬£${cost.toFixed(0)}</div>
                                                </div>
                                            </div>
                                            <small>Day ${day.day}</small>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
        }

        function generateProgressInsights(completionRate, confirmedDocs, totalDocs, completedTodos, totalTodos) {
            let insights = [];
            
            if (completionRate >= 0.8) {
                insights.push('üü¢ Excellent planning progress!');
            } else if (completionRate >= 0.5) {
                insights.push('üü° Good progress, keep it up!');
            } else {
                insights.push('üî¥ More planning needed');
            }
            
            if (totalDocs > 0) {
                const docRate = confirmedDocs / totalDocs;
                if (docRate >= 0.8) {
                    insights.push('üü¢ Most documents confirmed');
                } else {
                    insights.push('üü° Some documents pending');
                }
            }
            
            if (totalTodos > 0) {
                const todoRate = completedTodos / totalTodos;
                if (todoRate >= 0.8) {
                    insights.push('üü¢ Great task completion!');
                } else {
                    insights.push('üü° Tasks remaining');
                }
            }
            
            return insights.map(insight => `<p style="margin-bottom: 0.5rem;">${insight}</p>`).join('');
        }

        function getTransportEmoji(type) {
            const emojis = {
                'Bus': 'üöå', 'Train': 'üöÇ', 'Plane': '‚úàÔ∏è', 'Ferry': '‚õ¥Ô∏è', 
                'Car/Taxi': 'üöó', 'Walking': 'üö∂', 'Local Transport': 'üöä', 'Cycling': 'üö¥'
            };
            return emojis[type] || 'üöå';
        }

        function getAccommodationEmoji(type) {
            const emojis = {
                'Hostel': 'üè†', 'Hotel': 'üè®', 'Guesthouse': 'üè°', 'Camping': '‚õ∫',
                'Bus (sleeping)': 'üöå', 'Train (sleeping)': 'üöÇ', 'Airbnb': 'üè†',
                'Couchsurfing': 'üõãÔ∏è', "Friend's place": 'üë•', 'None (transit day)': 'üö∂'
            };
            return emojis[type] || 'üè†';
        }

        // Enhanced Backup Functions
        function exportFullBackup() {
            if (tripData.length === 0 && documentsData.length === 0 && todosData.length === 0) {
                showToast('‚ùå No data to export!', 'error');
                return;
            }

            const backup = {
                version: '2.0',
                exportDate: new Date().toISOString(),
                tripInfo,
                data: {
                    tripData,
                    documentsData: documentsData.map(doc => ({
                        ...doc,
                        file: doc.file ? {
                            ...doc.file,
                            data: '[FILE_DATA_REMOVED_FOR_SIZE]' // Remove large base64 data for JSON export
                        } : null
                    })),
                    todosData,
                    budgetData
                },
                metadata: {
                    dayCount: tripData.length,
                    documentCount: documentsData.length,
                    todoCount: todosData.length,
                    totalCost: tripData.reduce((sum, day) => sum + (day.transportCost || 0) + (day.accommodationCost || 0), 0)
                }
            };

            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `adventure_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showToast('‚úÖ Full backup exported successfully!', 'success');
        }

        function exportToCSV() {
            if (tripData.length === 0) {
                showToast('‚ùå No trip data to export!', 'error');
                return;
            }

            const headers = ['Day', 'Date', 'Location', 'Transport Type', 'Transport From', 'Transport To', 
                           'Transport Time', 'Transport Cost', 'Accommodation Type', 'Accommodation Name', 
                           'Accommodation Cost', 'Total Day Cost', 'Notes'];

            const csvContent = [
                headers.join(','),
                ...tripData.map(day => [
                    day.day,
                    day.date || '',
                    `"${(day.location || '').replace(/"/g, '""')}"`,
                    `"${(day.transportType || '').replace(/"/g, '""')}"`,
                    `"${(day.transportFrom || '').replace(/"/g, '""')}"`,
                    `"${(day.transportTo || '').replace(/"/g, '""')}"`,
                    `"${(day.transportTime || '').replace(/"/g, '""')}"`,
                    day.transportCost || 0,
                    `"${(day.accommodationType || '').replace(/"/g, '""')}"`,
                    `"${(day.accommodationName || '').replace(/"/g, '""')}"`,
                    day.accommodationCost || 0,
                    (day.transportCost || 0) + (day.accommodationCost || 0),
                    `"${(day.notes || '').replace(/"/g, '""')}"`
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${(tripInfo.name || 'trip').replace(/[^a-z0-9]/gi, '_').toLowerCase()}_data.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showToast('‚úÖ Trip data exported to CSV!', 'success');
        }

        function generateTextSummary() {
            if (tripData.length === 0) {
                showToast('‚ùå No trip data to generate summary!', 'error');
                return;
            }

            const tripName = tripInfo.name || 'My Adventure';
            const totalCost = tripData.reduce((sum, day) => sum + (day.transportCost || 0) + (day.accommodationCost || 0), 0);

            let text = `üéí ${tripName}\n${'='.repeat(60)}\n\n`;
            
            if (tripInfo.startDate && tripInfo.endDate) {
                text += `üìÖ ${tripInfo.startDate} ‚Üí ${tripInfo.endDate}\n`;
            }
            
            text += `üåç ${tripData.length} days of adventure\n`;
            text += `üë• Group size: ${tripInfo.groupSize || 1} traveler${(tripInfo.groupSize || 1) !== 1 ? 's' : ''}\n`;
            text += `‚úàÔ∏è Travel style: ${tripInfo.travelStyle || 'Not specified'}\n\n`;

            text += `üìä TRIP OVERVIEW\n${'-'.repeat(30)}\n`;
            text += `üí∞ Total Cost: ¬£${totalCost.toFixed(2)}\n`;
            text += `üìà Average per Day: ¬£${tripData.length > 0 ? (totalCost / tripData.length).toFixed(2) : '0.00'}\n`;
            text += `üìÑ Documents: ${documentsData.length} total, ${documentsData.filter(d => d.status === 'confirmed').length} confirmed\n`;
            text += `‚úÖ Tasks: ${todosData.length} total, ${todosData.filter(t => t.completed).length} completed\n\n`;

            text += `üìÖ DETAILED ITINERARY\n${'-'.repeat(30)}\n`;
            tripData.forEach(day => {
                const dayCost = (day.transportCost || 0) + (day.accommodationCost || 0);
                const completion = Math.round(calculateDayCompletion(day) * 100);
                
                text += `\nüìç Day ${day.day} - ${day.location || 'TBD'} (${completion}% complete)\n`;
                if (day.date) text += `üìÖ Date: ${day.date}\n`;
                
                text += `üöå Transport: ${day.transportFrom || 'TBD'} ‚Üí ${day.transportTo || 'TBD'}\n`;
                text += `   Type: ${day.transportType || 'TBD'}`;
                if (day.transportTime) text += ` at ${day.transportTime}`;
                text += `\n   Cost: ¬£${(day.transportCost || 0).toFixed(2)}\n`;
                
                text += `üè® Accommodation: ${day.accommodationType || 'TBD'}\n`;
                if (day.accommodationName) text += `   Place: ${day.accommodationName}\n`;
                text += `   Cost: ¬£${(day.accommodationCost || 0).toFixed(2)}\n`;
                
                const dayDocs = documentsData.filter(doc => doc.day === day.day);
                if (dayDocs.length > 0) {
                    text += `üìÑ Documents:\n`;
                    dayDocs.forEach(doc => {
                        text += `   ‚Ä¢ ${doc.type}: ${doc.name} (${doc.status})\n`;
                    });
                }
                
                if (day.notes) text += `üìù Notes: ${day.notes}\n`;
                text += `üí∞ Day Total: ¬£${dayCost.toFixed(2)}\n`;
            });

            if (todosData.length > 0) {
                text += `\n\n‚úÖ TASK LIST\n${'-'.repeat(30)}\n`;
                const pendingTasks = todosData.filter(t => !t.completed);
                const completedTasks = todosData.filter(t => t.completed);
                
                if (pendingTasks.length > 0) {
                    text += `\n‚è≥ PENDING TASKS (${pendingTasks.length}):\n`;
                    pendingTasks.forEach(task => {
                        text += `‚Ä¢ ${task.title}`;
                        if (task.priority === 'high') text += ' (HIGH PRIORITY)';
                        if (task.dueDate) text += ` - Due: ${task.dueDate}`;
                        text += `\n`;
                        if (task.description) text += `  ${task.description}\n`;
                    });
                }
                
                if (completedTasks.length > 0) {
                    text += `\n‚úÖ COMPLETED TASKS (${completedTasks.length}):\n`;
                    completedTasks.forEach(task => {
                        text += `‚Ä¢ ${task.title}\n`;
                    });
                }
            }
            
            text += `\n\nüéØ TRIP STATISTICS\n${'-'.repeat(30)}\n`;
            text += `üìÖ Total Days: ${tripData.length}\n`;
            text += `üí∞ Total Budget: ¬£${budgetData.totalBudget.toFixed(2)}\n`;
            text += `üí∏ Planned Spending: ¬£${totalCost.toFixed(2)}\n`;
            text += `üíµ Remaining Budget: ¬£${(budgetData.totalBudget - totalCost).toFixed(2)}\n`;
            
            const completionRate = tripData.length > 0 ? 
                tripData.filter(day => calculateDayCompletion(day) >= 0.8).length / tripData.length * 100 : 0;
            text += `üéØ Planning Completion: ${completionRate.toFixed(1)}%\n`;
            
            text += `\n${'='.repeat(60)}\n`;
            text += `üåü Generated by Adventure Planner v2.0\n`;
            text += `üìÖ Export Date: ${new Date().toLocaleDateString()}\n`;
            text += `üéí Safe travels and enjoy your adventure!\n`;
            text += `${'='.repeat(60)}`;

            showModal('Trip Summary', `<textarea readonly style="width: 100%; height: 500px; font-family: monospace; font-size: 0.9rem; padding: 1rem; border: 1px solid var(--border-color); border-radius: 8px;">${text}</textarea>
                <div style="text-align: center; margin-top: 1rem;">
                    <button class="btn btn-primary" onclick="copyToClipboard(\`${text.replace(/`/g, '\\`')}\`)">üìã Copy to Clipboard</button>
                    <button class="btn btn-secondary" onclick="downloadTextFile(\`${text.replace(/`/g, '\\`')}\`, '${tripInfo.name || 'trip'}_summary.txt')">üì• Download as Text</button>
                </div>`);
        }

        function importBackup(file) {
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    if (!backup.version || !backup.data) {
                        throw new Error('Invalid backup file format');
                    }
                    
                    if (confirm('This will replace all current data with the backup. Continue?\n\nTip: Export your current data first if you want to keep it!')) {
                        tripData = backup.data.tripData || [];
                        documentsData = backup.data.documentsData || [];
                        todosData = backup.data.todosData || [];
                        budgetData = { ...budgetData, ...(backup.data.budgetData || {}) };
                        tripInfo = backup.tripInfo || {};
                        
                        populateFormFields();
                        saveToStorage();
                        updateAllUI();
                        
                        showToast('‚úÖ Backup imported successfully!', 'success');
                        
                        // Show import summary
                        const summary = `
                            üìä Import Summary:
                            ‚Ä¢ ${tripData.length} days
                            ‚Ä¢ ${documentsData.length} documents
                            ‚Ä¢ ${todosData.length} tasks
                            ‚Ä¢ Backup from: ${new Date(backup.exportDate).toLocaleDateString()}
                        `;
                        showToast(summary, 'info', 8000);
                    }
                    
                } catch (error) {
                    console.error('Import error:', error);
                    showToast('‚ùå Invalid backup file! Please check the file format.', 'error');
                }
            };
            
            reader.readAsText(file);
        }

        function updateBackupStatus() {
            const lastSaved = window.adventurePlannerData?.lastSaved;
            const dataStats = {
                days: tripData.length,
                documents: documentsData.length,
                tasks: todosData.length,
                totalSize: new Blob([JSON.stringify({tripData, documentsData, todosData, budgetData, tripInfo})]).size
            };

            document.getElementById('backupStatus').innerHTML = `
                <div class="card" style="padding: 1.5rem;">
                    <h4>üìä Current Data Status</h4>
                    <div class="row">
                        <div class="col">
                            <p><strong>Last Saved:</strong> ${lastSaved ? new Date(lastSaved).toLocaleString() : 'Not saved yet'}</p>
                            <p><strong>Data Size:</strong> ${(dataStats.totalSize / 1024).toFixed(1)} KB</p>
                        </div>
                        <div class="col">
                            <p><strong>Items:</strong> ${dataStats.days} days, ${dataStats.documents} docs, ${dataStats.tasks} tasks</p>
                            <p><strong>Storage Used:</strong> ${((dataStats.totalSize / LIMITS.MAX_TOTAL_STORAGE) * 100).toFixed(1)}%</p>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-info" style="margin-top: 1rem;">
                    <div>
                        <strong>üí° Backup Tips:</strong><br>
                        ‚Ä¢ Export backups regularly to avoid data loss<br>
                        ‚Ä¢ JSON backups preserve all data except file attachments<br>
                        ‚Ä¢ CSV exports are great for spreadsheet analysis<br>
                        ‚Ä¢ Text summaries are perfect for sharing or printing
                    </div>
                </div>
            `;
        }

        function compressData() {
            let optimizations = [];
            let sizeSaved = 0;

            // Remove empty notes
            const emptyNotes = tripData.filter(day => day.notes && day.notes.trim() === '');
            if (emptyNotes.length > 0) {
                tripData.forEach(day => {
                    if (day.notes && day.notes.trim() === '') {
                        day.notes = '';
                    }
                });
                optimizations.push(`üóëÔ∏è Cleaned ${emptyNotes.length} empty notes`);
            }

            // Remove completed tasks older than 30 days
            const oldCompletedTasks = todosData.filter(task => 
                task.completed && task.dateCompleted && 
                (new Date() - new Date(task.dateCompleted)) > (30 * 24 * 60 * 60 * 1000)
            );
            if (oldCompletedTasks.length > 0 && confirm(`Remove ${oldCompletedTasks.length} completed tasks older than 30 days?`)) {
                todosData = todosData.filter(task => !oldCompletedTasks.includes(task));
                optimizations.push(`üóëÔ∏è Removed ${oldCompletedTasks.length} old completed tasks`);
            }

            // Suggest large file cleanup
            const largeFiles = documentsData.filter(doc => doc.file && doc.file.size > 1024 * 1024);
            if (largeFiles.length > 0) {
                optimizations.push(`üí° Consider removing ${largeFiles.length} large files (>1MB each)`);
            }

            if (optimizations.length > 0) {
                saveToStorage();
                updateAllUI();
                showToast(`‚úÖ Data optimized!\n${optimizations.join('\n')}`, 'success', 6000);
            } else {
                showToast('‚úÖ Data is already optimized!', 'success');
            }
        }

        function validateData() {
            let issues = [];
            let fixes = 0;

            // Check for duplicate days
            const dayNumbers = tripData.map(d => d.day);
            const duplicateDays = dayNumbers.filter((day, index) => dayNumbers.indexOf(day) !== index);
            if (duplicateDays.length > 0) {
                issues.push(`üî¥ Duplicate day numbers found: ${duplicateDays.join(', ')}`);
            }

            // Fix day numbering
            tripData.forEach((day, index) => {
                if (day.day !== index + 1) {
                    day.day = index + 1;
                    fixes++;
                }
            });

            // Check for invalid dates
            const invalidDates = tripData.filter(day => day.date && isNaN(new Date(day.date)));
            if (invalidDates.length > 0) {
                issues.push(`üî¥ ${invalidDates.length} invalid dates found`);
            }

            // Check for negative costs
            const negativeCosts = tripData.filter(day => 
                (day.transportCost && day.transportCost < 0) || 
                (day.accommodationCost && day.accommodationCost < 0)
            );
            if (negativeCosts.length > 0) {
                issues.push(`üî¥ ${negativeCosts.length} days with negative costs`);
                negativeCosts.forEach(day => {
                    if (day.transportCost < 0) day.transportCost = 0;
                    if (day.accommodationCost < 0) day.accommodationCost = 0;
                    fixes++;
                });
            }

            // Check for orphaned documents
            const orphanedDocs = documentsData.filter(doc => 
                !tripData.find(day => day.day === doc.day)
            );
            if (orphanedDocs.length > 0) {
                issues.push(`üü° ${orphanedDocs.length} documents linked to non-existent days`);
            }

            if (fixes > 0) {
                saveToStorage();
                updateAllUI();
            }

            const message = issues.length > 0 ? 
                `‚ö†Ô∏è Data validation complete:\n${issues.join('\n')}${fixes > 0 ? `\n‚úÖ ${fixes} issues auto-fixed` : ''}` :
                '‚úÖ Data validation passed! No issues found.';
            
            showToast(message, issues.length > 0 ? 'warning' : 'success', 8000);
        }

        function showDataStats() {
            const stats = {
                totalSize: new Blob([JSON.stringify({tripData, documentsData, todosData, budgetData, tripInfo})]).size,
                tripSize: new Blob([JSON.stringify(tripData)]).size,
                docsSize: new Blob([JSON.stringify(documentsData)]).size,
                todosSize: new Blob([JSON.stringify(todosData)]).size,
                filesSize: documentsData.reduce((total, doc) => total + (doc.file ? doc.file.size : 0), 0)
            };

            const content = `
                <div style="font-family: monospace;">
                    <h4>üìä Data Statistics</h4>
                    <table style="width: 100%; border-collapse: collapse; margin: 1rem 0;">
                        <tr style="background: var(--light-bg);">
                            <td style="padding: 0.5rem; border: 1px solid var(--border-color);"><strong>Category</strong></td>
                            <td style="padding: 0.5rem; border: 1px solid var(--border-color);"><strong>Items</strong></td>
                            <td style="padding: 0.5rem; border: 1px solid var(--border-color);"><strong>Size</strong></td>
                        </tr>
                        <tr>
                            <td style="padding: 0.5rem; border: 1px solid var(--border-color);">Trip Days</td>
                            <td style="padding: 0.5rem; border: 1px solid var(--border-color);">${tripData.length}</td>
                            <td style="padding: 0.5rem; border: 1px solid var(--border-color);">${(stats.tripSize / 1024).toFixed(1)} KB</td>
                        </tr>
                        <tr>
                            <td style="padding: 0.5rem; border: 1px solid var(--border-color);">Documents</td>
                            <td style="padding: 0.5rem; border: 1px solid var(--border-color);">${documentsData.length}</td>
                            <td style="padding: 0.5rem; border: 1px solid var(--border-color);">${(stats.docsSize / 1024).toFixed(1)} KB</td>
                        </tr>
                        <tr>
                            <td style="padding: 0.5rem; border: 1px solid var(--border-color);">Tasks</td>
                            <td style="padding: 0.5rem; border: 1px solid var(--border-color);">${todosData.length}</td>
                            <td style="padding: 0.5rem; border: 1px solid var(--border-color);">${(stats.todosSize / 1024).toFixed(1)} KB</td>
                        </tr>
                        <tr>
                            <td style="padding: 0.5rem; border: 1px solid var(--border-color);">File Attachments</td>
                            <td style="padding: 0.5rem; border: 1px solid var(--border-color);">${documentsData.filter(d => d.file).length}</td>
                            <td style="padding: 0.5rem; border: 1px solid var(--border-color);">${(stats.filesSize / 1024).toFixed(1)} KB</td>
                        </tr>
                        <tr style="background: var(--light-bg); font-weight: bold;">
                            <td style="padding: 0.5rem; border: 1px solid var(--border-color);">Total</td>
                            <td style="padding: 0.5rem; border: 1px solid var(--border-color);">${tripData.length + documentsData.length + todosData.length}</td>
                            <td style="padding: 0.5rem; border: 1px solid var(--border-color);">${(stats.totalSize / 1024).toFixed(1)} KB</td>
                        </tr>
                    </table>
                    
                    <div class="alert alert-info">
                        <strong>üíæ Storage Usage:</strong> ${((stats.totalSize / LIMITS.MAX_TOTAL_STORAGE) * 100).toFixed(1)}% of ${(LIMITS.MAX_TOTAL_STORAGE / (1024 * 1024))} MB limit
                    </div>
                </div>
            `;

            showModal('Data Statistics', content);
        }

        function clearAllData() {
            if (tripData.length === 0 && documentsData.length === 0 && todosData.length === 0) {
                showToast('‚ùå No data to clear!', 'error');
                return;
            }

            const totalItems = tripData.length + documentsData.length + todosData.length;
            
            if (confirm(`‚ö†Ô∏è DANGER: This will permanently delete ALL your trip data:\n\n‚Ä¢ ${tripData.length} days\n‚Ä¢ ${documentsData.length} documents\n‚Ä¢ ${todosData.length} tasks\n\nThis cannot be undone! Are you absolutely sure?`)) {
                if (confirm('üö® FINAL WARNING: All data will be lost forever. Type "DELETE" if you really want to continue.') && 
                    prompt('Type "DELETE" to confirm:') === 'DELETE') {
                    
                    tripData = [];
                    documentsData = [];
                    todosData = [];
                    budgetData = {
                        totalBudget: 1000,
                        foodBudget: 0,
                        activitiesBudget: 0,
                        localTransportBudget: 0,
                        shoppingBudget: 0,
                        gearBudget: 0,
                        miscBudget: 0,
                        emergencyBudget: 0,
                        insuranceBudget: 0,
                        visaBudget: 0
                    };
                    tripInfo = {};
                    
                    // Clear memory storage
                    delete window.adventurePlannerData;
                    
                    // Clear form fields
                    document.querySelectorAll('input, select, textarea').forEach(field => {
                        if (field.type === 'number') {
                            field.value = field.id === 'totalBudget' ? 1000 : 0;
                        } else if (field.type === 'checkbox') {
                            field.checked = false;
                        } else {
                            field.value = '';
                        }
                    });
                    
                    updateAllUI();
                    showToast(`‚úÖ All data cleared! ${totalItems} items deleted.`, 'success');
                    
                    // Reset to overview tab
                    showTab('overview');
                }
            }
        }

        // Enhanced Utility Functions
        function updateAllUI() {
            updateStorageMonitor();
            updateStatsOverview();
            updateDaysList();
            updateDocumentsView();
            updateTodosView();
            updateBudgetOverview();
        }

        function updateStatsOverview() {
            const totalCost = tripData.reduce((sum, day) => sum + (day.transportCost || 0) + (day.accommodationCost || 0), 0);
            const completedDays = tripData.filter(day => calculateDayCompletion(day) >= 0.8).length;
            const completionRate = tripData.length > 0 ? (completedDays / tripData.length * 100) : 0;

            if (tripData.length > 0 || documentsData.length > 0 || todosData.length > 0) {
                document.getElementById('totalDays').textContent = tripData.length;
                document.getElementById('totalCost').textContent = `¬£${totalCost.toFixed(0)}`;
                document.getElementById('documentsCount').textContent = documentsData.length;
                document.getElementById('tasksCount').textContent = todosData.length;
                document.getElementById('completionRate').textContent = `${completionRate.toFixed(0)}%`;
                document.getElementById('statsOverview').style.display = 'grid';
            } else {
                document.getElementById('statsOverview').style.display = 'none';
            }
        }

        function showModal(title, content) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            
            modal.innerHTML = `
                <div class="modal-content">
                    <button class="close-btn" onclick="closeModal(this)">&times;</button>
                    <h3>${title}</h3>
                    <div style="margin: 1rem 0;">
                        ${content}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            setTimeout(() => modal.classList.add('show'), 100);
        }

        function closeModal(element) {
            const modal = element.closest('.modal');
            if (modal) {
                modal.classList.remove('show');
                setTimeout(() => modal.remove(), 300);
            }
        }

        function copyToClipboard(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    showToast('‚úÖ Copied to clipboard!', 'success');
                }).catch(() => {
                    fallbackCopyToClipboard(text);
                });
            } else {
                fallbackCopyToClipboard(text);
            }
        }

        function fallbackCopyToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.opacity = '0';
            document.body.appendChild(textArea);
            textArea.select();
            
            try {
                document.execCommand('copy');
                showToast('‚úÖ Copied to clipboard!', 'success');
            } catch (err) {
                showToast('‚ùå Failed to copy to clipboard', 'error');
            }
            
            document.body.removeChild(textArea);
        }

        function downloadTextFile(text, filename) {
            const blob = new Blob([text], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showToast('‚úÖ File downloaded!', 'success');
        }

        function toggleCollapsible(header) {
            const collapsible = header.closest('.collapsible');
            collapsible.classList.toggle('active');
        }

        function showStorageDetails() {
            showDataStats();
        }

        function optimizeStorage() {
            compressData();
        }

        function suggestOptimization() {
            const largeFiles = documentsData.filter(doc => doc.file && doc.file.size > 512 * 1024);
            const oldTasks = todosData.filter(task => 
                task.completed && task.dateCompleted && 
                (new Date() - new Date(task.dateCompleted)) > (30 * 24 * 60 * 60 * 1000)
            );

            let suggestions = [];
            if (largeFiles.length > 0) {
                suggestions.push(`üóëÔ∏è Remove ${largeFiles.length} large files (>512KB)`);
            }
            if (oldTasks.length > 0) {
                suggestions.push(`üóëÔ∏è Clean up ${oldTasks.length} old completed tasks`);
            }
            
            if (suggestions.length > 0) {
                const message = `üí° Storage Optimization Suggestions:\n${suggestions.join('\n')}\n\nUse the "Compress Data" button in the Backup tab to optimize automatically.`;
                showToast(message, 'info', 8000);
            }
        }

        // Add CSS for missing badge styles
        const additionalStyles = `
            <style>
                .badge {
                    padding: 0.25rem 0.5rem;
                    border-radius: 12px;
                    font-size: 0.8rem;
                    font-weight: 600;
                    white-space: nowrap;
                }
                .badge-success { background: var(--success-color); color: white; }
                .badge-warning { background: var(--warning-color); color: #212529; }
                .badge-danger { background: var(--danger-color); color: white; }
                .badge-info { background: var(--info-color); color: white; }
                .priority-high { background: var(--danger-color); color: white; }
                .priority-medium { background: var(--warning-color); color: #212529; }
                .priority-low { background: var(--success-color); color: white; }
                .btn-sm { padding: 0.375rem 0.75rem; font-size: 0.875rem; }
            </style>
        `;
        document.head.insertAdjacentHTML('beforeend', additionalStyles);

    </script>
</body>
